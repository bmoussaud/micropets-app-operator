---
apiVersion: tekton.dev/v1beta1
kind: Task
metadata:
  name: untar
spec:
  workspaces:
    - description: The workspace consisting of untar project.
      name: source
  steps:
    - name: untar
      image: ubuntu
      script: |
        #!/bin/bash        
        cd /workspace/source
        tar zxvf /workspace/source/sources.tar.gz        
        find /workspace -ls      
---
apiVersion: tekton.dev/v1beta1
kind: Task
metadata:
  name: mymaventask
spec:
  workspaces:
    - description: Maven
      name: source
  steps:
    - name: test
      image: gcr.io/cloud-builders/mvn
      script: |
        #!/bin/bash
        set -x 
        id 
        id
        find /workspace -ls 
        cd /workspace/source        
        mvn -X test -Dproject.build.sourceEncoding=UTF-8 -Dproject.reporting.outputEncoding=UTF-8
        
        
---
apiVersion: tekton.dev/v1beta1
kind: Pipeline
metadata:
  name: maven-test-pipeline
  labels:    
    apps.tanzu.vmware.com/pipeline: not_used_test
spec:
  description: >-
    The Mvn pipeline builds source from a Git repository into a container image and run tests using maven
  workspaces:
    - name: source-ws
      description: Location where source is stored.
  params:
    - name: source-url
      description: A git repo url where the source code resides.
    - name: SOURCE_REFERENCE
      description: The branch, tag or SHA to checkout.
      default: ""
    - name: SOURCE_SUBPATH
      description: A subpath within checked out source where the source to build is located.
      default: ""
  tasks:
    - name: fetch-from-git
      taskRef:
        name: wget
      params:
        - name: url
          value: $(params.source-url)
        - name: diroptions
          value:
            - "-O"
        - name: filename
          value: sources.tar.gz
      workspaces:
        - name: wget-workspace
          workspace: source-ws
    - name: untar
      runAfter:
        - fetch-from-git
      taskRef:
        name: untar
      workspaces:
        - name: source
          workspace: source-ws
    - name: run-tests
      runAfter:
        - untar
      taskRef:
        name: maven
      workspaces:      
        - name: source
          workspace: source-ws
        - name: maven-settings
          workspace: source-ws
      params:
        - name: GOALS
          value:            
            - test
---
apiVersion: tekton.dev/v1beta1
kind: PipelineRun
metadata:
  name: maven-test-pipeline-1
spec:
  pipelineRef:
    name: maven-test-pipeline
  params:
    - name: source-url                  
      value: http://source-controller-manager-artifact-service.source-system.svc.cluster.local./imagerepository/dev-tap/birds/ef8df1605f55e595c0bf609c92fdff083c7fe2176c8dc20ea964ea90b145b68c.tar.gz
  workspaces:
    - name: source-ws # this workspace name must be declared in the Pipeline
      volumeClaimTemplate:
        spec:
          accessModes:
            - ReadWriteOnce # access mode may affect how you can use this volume in parallel tasks
          resources:
            requests:
              storage: 5Gi
